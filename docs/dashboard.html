<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthMetric Dashboard - Ennead Architects</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js?v=2.0"></script>
    
    <!-- CSS -->
    <link rel="stylesheet" href="styles/base.css?v=2.0">
    <link rel="stylesheet" href="styles/layout.css?v=2.0">
    <link rel="stylesheet" href="styles/animations.css?v=2.0">
    <link rel="stylesheet" href="styles/responsive.css?v=2.0">
    <link rel="stylesheet" href="styles/components/dashboard.css?v=2.0">
    <link rel="stylesheet" href="styles/components/charts.css?v=2.0">
    <link rel="stylesheet" href="styles/components/navigation.css?v=2.0">
    <link rel="stylesheet" href="styles/components/comprehensive-data.css?v=2.0">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <img src="asset/icon/performance.png" alt="Dashboard" class="icon icon-24 icon-with-text icon-invert">
                <span>HealthMetric Dashboard</span>
            </div>
            <div class="nav-actions">
                <div class="filter-status" id="filterStatus">
                    <span class="filter-label">Showing: All Data</span>
                </div>
                <button class="btn btn-secondary" id="backToHero" onclick="navigateToHero()" style="cursor: pointer;">
                    <img src="asset/icon/usage.png" alt="Back" class="icon icon-16 icon-with-text icon-invert">Back to Hero
                </button>
                <button class="btn btn-primary" id="refreshData">
                    <img src="asset/icon/refresh.png" alt="Refresh" class="icon icon-16 icon-with-text">Refresh Data
                </button>
            </div>
            <div class="nav-branding">
                <span class="powered-by">Powered by <strong>EnneadTab</strong></span>
                <span class="work-in-progress"><img src="asset/icon/warning.png" alt="Work In Progress" class="icon icon-16 icon-with-text icon-invert">Work In Progress</span>
            </div>
        </div>
    </nav>

    <!-- Main Dashboard Layout -->
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Project Tree</h3>
            </div>
            
            <!-- Project Tree Structure -->
            <div class="project-tree" id="projectTree">
                <!-- Project tree will be dynamically generated from SexyDuck data -->
            </div>
            
            <!-- Quick Filters -->
            <div class="filter-section">
                <h4><img src="asset/icon/analyze.png" alt="Filters" class="icon icon-20 icon-with-text">Data Category Filters</h4>
                <div class="filter-options">
                    <!-- Warnings Filter -->
                    <div class="filter-group">
                        <h5>Warnings</h5>
                    <label class="filter-option">
                            <input type="checkbox" id="showWarningsOnly" checked>
                            <span>Models with Warnings</span>
                    </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showCriticalWarnings" checked>
                            <span>Critical Warnings Only</span>
                        </label>
                    </div>
                    
                    <!-- Model Size Filter -->
                    <div class="filter-group">
                        <h5>Model Size</h5>
                    <label class="filter-option">
                        <input type="checkbox" id="showLargeModels" checked>
                        <span>Large Models (>10K elements)</span>
                    </label>
                    <label class="filter-option">
                            <input type="checkbox" id="showSmallModels" checked>
                            <span>Small Models (<1K elements)</span>
                    </label>
                    </div>
                    
                    <!-- Revit Application Version Filter -->
                    <div class="filter-group">
                        <h5>Revit Application Version</h5>
                        <label class="filter-option">
                            <input type="checkbox" id="showRevit2024" checked>
                            <span>Revit 2024 Application</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showRevit2023" checked>
                            <span>Revit 2023 Application</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showRevit2025" checked>
                            <span>Revit 2025 Application</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showRevit2026" checked>
                            <span>Revit 2026 Application</span>
                        </label>
                    </div>
                    
                    
                    
                    <!-- Data Richness Filter -->
                    <div class="filter-group">
                        <h5>Data Richness</h5>
                        <label class="filter-option">
                            <input type="checkbox" id="showRichFamilies" checked>
                            <span>Rich Family Data</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showRichViews" checked>
                            <span>Rich View Data</span>
                        </label>
                        <label class="filter-option">
                            <input type="checkbox" id="showRichWorksets" checked>
                            <span>Rich Workset Data</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Date Range Filter -->
            <div class="filter-section">
                <h4>Date Range</h4>
                <div class="date-range">
                    <input type="date" id="dateFrom" class="date-input">
                    <input type="date" id="dateTo" class="date-input">
                </div>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Search Bar -->
            <div class="search-section">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search projects, hubs, models..." class="search-input">
                    <button class="search-btn" id="searchBtn"><img src="asset/icon/analyze.png" alt="Search" class="icon icon-16"></button>
                </div>
                <div class="search-filters">
                    <select id="searchType" class="search-select">
                        <option value="all">All</option>
                        <option value="project">Project</option>
                        <option value="hub">Hub</option>
                        <option value="model">Model</option>
                    </select>
                </div>
            </div>
            
            <!-- Dashboard Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon"><img src="asset/icon/building.png" alt="Hubs" class="icon icon-24 icon-invert"></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalHubs">-</div>
                        <div class="stat-label">Hubs</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><img src="asset/icon/data.png" alt="Projects" class="icon icon-24 icon-invert"></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalProjects">-</div>
                        <div class="stat-label">Projects</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><img src="asset/icon/usage.png" alt="Models" class="icon icon-24 icon-invert"></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalModels">-</div>
                        <div class="stat-label">Models</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><img src="asset/icon/performance.png" alt="Files" class="icon icon-24"></div>
                    <div class="stat-content">
                        <div class="stat-value" id="totalFiles">-</div>
                        <div class="stat-label">Data Files</div>
                    </div>
                </div>
            </div>
            
            <!-- Comprehensive Data Display -->
            <div class="comprehensive-data-section">
                <h3><img src="asset/icon/performance.png" alt="Analysis" class="icon icon-24 icon-with-text">Detailed Analysis</h3>
                
                <!-- Project Overview -->
                <div class="data-card">
                    <h4><img src="asset/icon/building.png" alt="Project" class="icon icon-20 icon-with-text icon-invert">Project Overview</h4>
                    <div class="project-overview" id="projectOverview">
                        <!-- Project information will be populated here -->
                    </div>
                </div>
                
                <!-- Warning Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/warning.png" alt="Warning" class="icon icon-20 icon-with-text icon-invert">Warning Analysis</h4>
                    <div class="warning-breakdown">
                        <div class="warning-categories" id="warningCategories">
                            <!-- Warning categories will be populated here -->
                        </div>
                        <div class="warning-users" id="warningUsers">
                            <!-- User-specific warnings will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Model Structure -->
                <div class="data-card">
                    <h4><img src="asset/icon/tree-node.png" alt="Structure" class="icon icon-20 icon-with-text icon-invert">Model Structure</h4>
                    <div class="model-structure">
                        <div class="view-breakdown" id="viewBreakdown">
                            <!-- View types breakdown will be populated here -->
                        </div>
                        <div class="element-breakdown" id="elementBreakdown">
                            <!-- Element counts will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Families Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/data.png" alt="Families" class="icon icon-20 icon-with-text icon-invert">Families Analysis</h4>
                    <div class="families-analysis" id="familiesAnalysis">
                        <!-- Families data will be populated here -->
                    </div>
                </div>

                <!-- Group Usage Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/usage.png" alt="Group Usage" class="icon icon-20 icon-with-text icon-invert">Group Usage Analysis</h4>
                    <div class="group-usage" id="groupUsage">
                        <!-- Group usage analysis will be populated here -->
                    </div>
                </div>

                <!-- Templates & Filters -->
                <div class="data-card">
                    <h4><img src="asset/icon/analyze.png" alt="Templates" class="icon icon-20 icon-with-text">Templates & Filters</h4>
                    <div class="templates-filters" id="templatesFilters">
                        <!-- Templates and filters analysis will be populated here -->
                    </div>
                </div>

                <!-- CAD Files Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/download-csv.png" alt="CAD Files" class="icon icon-20 icon-with-text">CAD Files Analysis</h4>
                    <div class="cad-files-analysis" id="cadFilesAnalysis">
                        <!-- CAD files data will be populated here -->
                    </div>
                </div>

                <!-- Rooms Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/tree-node.png" alt="Rooms" class="icon icon-20 icon-with-text">Rooms Analysis</h4>
                    <div class="rooms-analysis" id="roomsAnalysis">
                        <!-- Rooms data will be populated here -->
                    </div>
                </div>

                <!-- Worksets Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/performance.png" alt="Worksets" class="icon icon-20 icon-with-text">Worksets Analysis</h4>
                    <div class="worksets-analysis" id="worksetsAnalysis">
                        <!-- Worksets data will be populated here -->
                    </div>
                </div>

                <!-- Revit Application Version Analysis -->
                <div class="data-card">
                    <h4><img src="asset/icon/building.png" alt="Revit Application Version" class="icon icon-20 icon-with-text">Revit Application Version Analysis</h4>
                    <div class="revit-version-analysis" id="revitVersionAnalysis">
                        <!-- Revit application version data will be populated here -->
                    </div>
                </div>

                <!-- Performance Metrics -->
                <div class="data-card">
                    <h4><img src="asset/icon/performance.png" alt="Performance" class="icon icon-20 icon-with-text">Performance Metrics</h4>
                    <div class="performance-metrics" id="performanceMetrics">
                        <!-- Performance data will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Project Comparison</h3>
                        <div class="chart-controls">
                            <select id="comparisonMetric" class="chart-select">
                                <option value="totalElements">Total Elements</option>
                                <option value="totalViews">Total Views</option>
                                <option value="warningCount">Warnings</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="comparisonChart"></canvas>
                    </div>
                </div>
            </div>
            
            <!-- Data Table -->
            <div class="data-table-section">
                <div class="table-header">
                    <h3>Project Data</h3>
                    <div class="table-controls">
                        <button class="btn btn-secondary" id="exportData"><img src="asset/icon/download-csv.png" alt="Export" class="icon icon-16 icon-with-text">Export CSV</button>
                        <button class="btn btn-secondary" id="printData"><img src="asset/icon/print.png" alt="Print" class="icon icon-16 icon-with-text">Print</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table" id="dataTable">
                        <thead>
                            <tr>
                                <th class="sortable" data-sort="hubName">Hub <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="projectName">Project <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="modelName">Model <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="timestamp">Date <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="totalElements">Elements <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="totalViews">Views <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="warningCount">Warnings <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="executionTime">Exec Time <span class="sort-icon">â‡…</span></th>
                                <th class="sortable" data-sort="revitVersion">Revit Version <span class="sort-icon">â‡…</span></th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                            <!-- Data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Loading Dashboard Data...</div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="js/data/DataPlugin.js"></script>
    <script src="js/data/DataLoader.js"></script>
    <script>
        // Dashboard Application
        class DashboardApp {
            constructor() {
                this.data = [];
                this.filteredData = [];
                this.charts = {};
                this.currentSort = { column: null, direction: 'asc' };
                this.init();
            }
            
            async init() {
                this.showLoading();
                
                try {
                    await this.loadData();
                    this.setupEventListeners();
                    this.updateStats();
                    this.renderTable();
                    this.createComparisonChart();
                    this.updateComprehensiveData();
                } catch (error) {
                    console.error('Error initializing dashboard:', error);
                    // Show error message to user
                    this.showError('Failed to load dashboard data. Please refresh the page.');
                } finally {
                    // Always hide loading, even if there's an error
                    setTimeout(() => {
                        this.hideLoading();
                    }, 1000); // Minimum 1 second loading time
                }
            }
            
            async loadSexyDuckData() {
                try {
                    console.log('ðŸ”„ Loading SexyDuck data files...');
                    
                    // Load manifest to get file list
                    const manifestResponse = await fetch('asset/data/manifest.json');
                    if (!manifestResponse.ok) {
                        throw new Error(`Failed to load manifest: ${manifestResponse.status}`);
                    }
                    const manifest = await manifestResponse.json();
                    
                    this.data = [];
                    
                    // Load each SexyDuck file
                    for (const fileInfo of manifest.files) {
                        try {
                            console.log(`ðŸ”„ Loading ${fileInfo.filename}...`);
                            const response = await fetch(`asset/data/${fileInfo.filename}`);
                            if (!response.ok) {
                                console.warn(`âš ï¸ Failed to load ${fileInfo.filename}: ${response.status}`);
                                continue;
                            }
                            const sexDuckData = await response.json();
                            
                            // Extract and transform the data
                            const transformedData = this.transformSexyDuckData(sexDuckData, fileInfo);
                            this.data.push(transformedData);
                            
                        } catch (error) {
                            console.warn(`âš ï¸ Failed to load ${fileInfo.filename}:`, error);
                        }
                    }
                    
                    // If no data loaded, show error
                    if (this.data.length === 0) {
                        console.error('âŒ No SexyDuck data loaded');
                        throw new Error('No SexyDuck data files could be loaded');
                    }
                    
                    this.filteredData = [...this.data];
                    console.log(`âœ… Loaded ${this.data.length} SexyDuck files`);
                    
                } catch (error) {
                    console.error('âŒ Error loading SexyDuck data:', error);
                    // Show error to user instead of fallback
                    this.showError(`Failed to load SexyDuck data: ${error.message}`);
                    throw error;
                }
            }
            
            transformSexyDuckData(sexDuckData, fileInfo) {
                const resultData = sexDuckData.result_data || {};
                const jobMetadata = sexDuckData.job_metadata || {};
                
                return {
                    // Basic info
                    hubName: jobMetadata.hub_name || fileInfo.hub,
                    projectName: jobMetadata.project_name || fileInfo.project,
                    modelName: jobMetadata.model_name || fileInfo.model,
                    timestamp: new Date(jobMetadata.timestamp || fileInfo.timestamp),
                    filename: fileInfo.filename,
                    
                    // Basic metrics
                    totalElements: resultData.total_elements || 0,
                    totalViews: resultData.views_sheets?.total_views || 0,
                    totalSheets: resultData.views_sheets?.total_sheets || 0,
                    totalFamilies: resultData.families?.total_families || 0,
                    totalRooms: resultData.rooms?.total_rooms || 0,
                    warningCount: resultData.warning_count || 0,
                    criticalWarningCount: resultData.critical_warning_count || 0,
                    viewsNotOnSheets: resultData.views_sheets?.views_not_on_sheets || 0,
                    copiedViews: resultData.views_sheets?.copied_views || 0,
                    dimensions: resultData.dimensions || 0,
                    materials: resultData.materials || 0,
                    executionTime: jobMetadata.execution_time_seconds || 0,
                    revitVersion: jobMetadata.revit_version || 'Unknown',
                    jobId: jobMetadata.job_id || 'Unknown',
                    isEnneadTabAvailable: resultData.is_EnneadTab_Available || false,
                    status: sexDuckData.status || 'unknown',
                    parsedAt: new Date(),
                    format: 'SexyDuck',
                    
                    // Rich data structures
                    textNotesInstances: resultData.text_notes_instances || 0,
                    textNotesTypes: resultData.text_notes_types || 0,
                    dimensionOverrides: resultData.dimension_overrides || 0,
                    dimensionTypes: resultData.dimension_types || 0,
                    detailGroupTypes: resultData.detail_group_types || 0,
                    detailGroupInstances: resultData.detail_group_instances || 0,
                    isWorkshared: resultData.project_info?.is_workshared || false,
                    projectPhases: resultData.project_info?.project_phases || [],
                    
                    // Nested data structures
                    viewTypes: resultData.views_sheets?.view_types || {},
                    warningCategories: resultData.warnings?.warning_categories || {},
                    warningDetailsPerUser: resultData.warnings?.warning_details_per_user || {},
                    modelGroupUsage: resultData.model_group_usage_analysis || {},
                    detailGroupUsage: resultData.detail_group_usage_analysis || {},
                    templatesFilters: resultData.templates_filters || {},
                    families: resultData.families || {},
                    cad_files: resultData.cad_files || {},
                    rooms: resultData.rooms || {},
                    project_info: resultData.project_info || {},
                    
                    // Additional metrics
                    purgeableElements: resultData.purgeable_elements || 0,
                    referencePlanes: resultData.reference_planes || 0,
                    linkedFiles: resultData.linked_files || [],
                    linkedFilesCount: resultData.linked_files_count || 0,
                    revisionClouds: resultData.revision_clouds || 0,
                    linePatterns: resultData.line_patterns || 0,
                    referencePlanesNoName: resultData.reference_planes_no_name || 0,
                    modelGroupTypes: resultData.model_group_types || 0,
                    modelGroupInstances: resultData.model_group_instances || 0,
                    detailLines: resultData.detail_lines || 0,
                    textNotesWidthFactorNot1: resultData.text_notes_width_factor_not_1 || 0,
                    textNotesTypesSolidBackground: resultData.text_notes_types_solid_background || 0,
                    textNotesAllCaps: resultData.text_notes_all_caps || 0
                };
            }
            
            
            async loadData() {
                try {
                    console.log('ðŸ”„ Loading dashboard data...');
                    
                    // Check if data was preloaded from hero page
                    const preloadedData = sessionStorage.getItem('dashboardData');
                    if (preloadedData) {
                        console.log('âœ… Using preloaded data from hero page');
                        this.data = JSON.parse(preloadedData).map(item => ({
                            ...item,
                            timestamp: new Date(item.timestamp)
                        }));
                        return;
                    }
                    
                    console.log('ðŸ”„ No preloaded data found, loading from SexyDuck files...');
                    
                    // Load actual SexyDuck data files
                    await this.loadSexyDuckData();
                    return;
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError(`Failed to load data: ${error.message}`);
                }
            }
            
            setupEventListeners() {
                // Search functionality
                const searchInput = document.getElementById('searchInput');
                const searchBtn = document.getElementById('searchBtn');
                
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.handleSearch(e.target.value);
                    });
                }
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => {
                        this.handleSearch(document.getElementById('searchInput').value);
                    });
                }
                
                // Date range filters
                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');
                
                if (dateFrom) {
                    dateFrom.addEventListener('change', () => {
                        this.handleDateFilter();
                    });
                }
                
                if (dateTo) {
                    dateTo.addEventListener('change', () => {
                        this.handleDateFilter();
                    });
                }
                
                // Category-based filters
                this.setupCategoryFilters();
                
                // Chart controls
                const chartMetric = document.getElementById('chartMetric');
                const chartGroupBy = document.getElementById('chartGroupBy');
                const comparisonMetric = document.getElementById('comparisonMetric');
                
                if (chartMetric) {
                    chartMetric.addEventListener('change', () => {
                        this.updateTimeSeriesChart();
                    });
                }
                
                if (chartGroupBy) {
                    chartGroupBy.addEventListener('change', () => {
                        this.updateTimeSeriesChart();
                    });
                }
                
                if (comparisonMetric) {
                    comparisonMetric.addEventListener('change', () => {
                        this.updateComparisonChart();
                    });
                }
                
                // Table sorting
                document.querySelectorAll('.sortable').forEach(header => {
                    header.addEventListener('click', () => {
                        this.sortTable(header.dataset.sort);
                    });
                });
                
                // Navigation
                const backToHero = document.getElementById('backToHero');
                const refreshData = document.getElementById('refreshData');
                
                if (backToHero) {
                    console.log('âœ… Back to Hero button found, adding event listener');
                    backToHero.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('ðŸ”„ Navigating back to hero page');
                        try {
                            window.location.href = 'index.html';
                        } catch (error) {
                            console.error('âŒ Navigation failed:', error);
                            // Fallback: try to go back in history
                            window.history.back();
                        }
                    });
                } else {
                    console.error('âŒ Back to Hero button not found!');
                }
                
                if (refreshData) {
                    refreshData.addEventListener('click', () => {
                        this.init();
                    });
                }
                
                // Export functionality
                const exportData = document.getElementById('exportData');
                const printData = document.getElementById('printData');
                
                if (exportData) {
                    exportData.addEventListener('click', () => {
                        this.exportToCSV();
                    });
                }
                
                if (printData) {
                    printData.addEventListener('click', () => {
                        window.print();
                    });
                }
                
                // Tree structure interactions
                this.setupTreeInteractions();
            }
            
            setupTreeInteractions() {
                console.log('ðŸŒ³ Setting up tree interactions...');
                
                // Tree toggle functionality
                document.querySelectorAll('.tree-toggle').forEach((toggle, index) => {
                    console.log(`ðŸŒ³ Setting up toggle ${index + 1}:`, toggle);
                    
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        console.log('ðŸ”„ Toggle clicked:', toggle);
                        
                        const treeItem = toggle.closest('.tree-item');
                        const children = treeItem.nextElementSibling;
                        
                        console.log('ðŸŒ³ Tree item:', treeItem);
                        console.log('ðŸŒ³ Children element:', children);
                        
                        if (children && children.classList.contains('tree-children')) {
                            const isCollapsed = children.classList.contains('collapsed');
                            
                            if (isCollapsed) {
                                // Expand
                                children.classList.remove('collapsed');
                                toggle.classList.remove('collapsed');
                                toggle.classList.add('expanded');
                                console.log('âœ… Expanded children');
                            } else {
                                // Collapse
                                children.classList.add('collapsed');
                                toggle.classList.remove('expanded');
                                toggle.classList.add('collapsed');
                                console.log('âœ… Collapsed children');
                            }
                        } else {
                            console.warn('âš ï¸ No children found for toggle');
                        }
                    });
                });
                
                console.log(`ðŸŒ³ Set up ${document.querySelectorAll('.tree-toggle').length} tree toggles`);
                
                // Hub item clicks - show all data for that hub
                document.querySelectorAll('.hub-item').forEach(hubItem => {
                    hubItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const hubName = hubItem.dataset.hub;
                        this.filterByHub(hubName);
                        this.highlightTreeItem(hubItem);
                    });
                });
                
                // Project item clicks - filter by project
                document.querySelectorAll('.project-item').forEach(projectItem => {
                    projectItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const projectName = projectItem.dataset.project;
                        this.filterByProject(projectName);
                        this.highlightTreeItem(projectItem);
                    });
                });
                
                // Model item clicks - filter by model
                document.querySelectorAll('.model-item').forEach(modelItem => {
                    modelItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const modelName = modelItem.dataset.model;
                        this.filterByModel(modelName);
                        this.highlightTreeItem(modelItem);
                    });
                });
            }
            
            filterByHub(hubName) {
                this.filteredData = this.data.filter(item => item.hubName === hubName);
                this.updateStats();
                this.renderTable();
                this.updateComparisonChart();
                this.updateComprehensiveData();
                this.updateFilterStatus(`Hub: ${hubName}`);
                console.log(`Filtered by hub: ${hubName}`);
            }
            
            filterByProject(projectName) {
                this.filteredData = this.data.filter(item => item.projectName === projectName);
                this.updateStats();
                this.renderTable();
                this.updateComparisonChart();
                this.updateComprehensiveData();
                this.updateFilterStatus(`Project: ${projectName}`);
                console.log(`Filtered by project: ${projectName}`);
            }
            
            filterByModel(modelName) {
                this.filteredData = this.data.filter(item => item.modelName === modelName);
                this.updateStats();
                this.renderTable();
                this.updateComparisonChart();
                this.updateComprehensiveData();
                this.updateFilterStatus(`Model: ${modelName}`);
                console.log(`Filtered by model: ${modelName}`);
            }
            
            showAllData() {
                this.filteredData = [...this.data];
                this.updateStats();
                this.renderTable();
                this.updateComparisonChart();
                this.updateComprehensiveData();
                this.updateFilterStatus('All Data');
                console.log('Showing all data');
            }
            
            updateFilterStatus(status) {
                const filterStatus = document.getElementById('filterStatus');
                if (filterStatus) {
                    const filterLabel = filterStatus.querySelector('.filter-label');
                    if (filterLabel) {
                        filterLabel.textContent = `Showing: ${status}`;
                    }
                }
            }
            
            highlightTreeItem(selectedItem) {
                // Remove previous selection
                document.querySelectorAll('.tree-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add selection to clicked item
                selectedItem.classList.add('selected');
            }
            
            handleSearch(query) {
                if (!query.trim()) {
                    this.filteredData = [...this.data];
                } else {
                    const searchType = document.getElementById('searchType').value;
                    this.filteredData = this.data.filter(item => {
                        const searchText = query.toLowerCase();
                        switch (searchType) {
                            case 'project':
                                return item.projectName.toLowerCase().includes(searchText);
                            case 'hub':
                                return item.hubName.toLowerCase().includes(searchText);
                            case 'model':
                                return item.modelName.toLowerCase().includes(searchText);
                            default:
                                return item.projectName.toLowerCase().includes(searchText) ||
                                       item.hubName.toLowerCase().includes(searchText) ||
                                       item.modelName.toLowerCase().includes(searchText);
                        }
                    });
                }
                this.renderTable();
                this.updateCharts();
            }
            
            handleDateFilter() {
                let filtered = [...this.data];
                
                // Date range filter
                const dateFrom = document.getElementById('dateFrom');
                const dateTo = document.getElementById('dateTo');
                
                if (dateFrom && dateFrom.value) {
                    filtered = filtered.filter(item => item.timestamp >= new Date(dateFrom.value));
                }
                
                if (dateTo && dateTo.value) {
                    filtered = filtered.filter(item => item.timestamp <= new Date(dateTo.value));
                }
                
                this.filteredData = filtered;
                this.renderTable();
                this.updateCharts();
                this.updateComprehensiveData();
            }
            
            setupCategoryFilters() {
                // Get all filter checkboxes
                const filterIds = [
                    'showWarningsOnly', 'showCriticalWarnings',
                    'showLargeModels', 'showSmallModels',
                    'showRevit2024', 'showRevit2023', 'showRevit2025', 'showRevit2026',
                    'showRichFamilies', 'showRichViews', 'showRichWorksets'
                ];
                
                // Add event listeners to all filter checkboxes
                filterIds.forEach(id => {
                    const checkbox = document.getElementById(id);
                    if (checkbox) {
                        checkbox.addEventListener('change', () => {
                            this.applyCategoryFilters();
                        });
                    }
                });
            }
            
            applyCategoryFilters() {
                let filtered = [...this.data];
                
                // Warnings filters
                const showWarningsOnly = document.getElementById('showWarningsOnly')?.checked;
                const showCriticalWarnings = document.getElementById('showCriticalWarnings')?.checked;
                
                if (showWarningsOnly !== undefined) {
                    if (showWarningsOnly) {
                        filtered = filtered.filter(item => (item.warningCount || 0) > 0);
                    }
                }
                
                if (showCriticalWarnings !== undefined) {
                    if (showCriticalWarnings) {
                        filtered = filtered.filter(item => (item.criticalWarningCount || 0) > 0);
                    }
                }
                
                // Model size filters
                const showLargeModels = document.getElementById('showLargeModels')?.checked;
                const showSmallModels = document.getElementById('showSmallModels')?.checked;
                
                if (showLargeModels !== undefined) {
                    if (showLargeModels) {
                        filtered = filtered.filter(item => (item.totalElements || 0) > 10000);
                    }
                }
                
                if (showSmallModels !== undefined) {
                    if (showSmallModels) {
                        filtered = filtered.filter(item => (item.totalElements || 0) < 1000);
                    }
                }
                
                // Revit application version filters (Autodesk Revit year versions like 2024, 2025, 2026)
                const showRevit2024 = document.getElementById('showRevit2024')?.checked;
                const showRevit2023 = document.getElementById('showRevit2023')?.checked;
                const showRevit2025 = document.getElementById('showRevit2025')?.checked;
                const showRevit2026 = document.getElementById('showRevit2026')?.checked;
                
                const versionFilters = [];
                if (showRevit2024) versionFilters.push('2024');
                if (showRevit2023) versionFilters.push('2023');
                if (showRevit2025) versionFilters.push('2025');
                if (showRevit2026) versionFilters.push('2026');
                
                if (versionFilters.length > 0) {
                    filtered = filtered.filter(item => versionFilters.includes(item.revitVersion));
                }
                
                
                
                // Data richness filters
                const showRichFamilies = document.getElementById('showRichFamilies')?.checked;
                const showRichViews = document.getElementById('showRichViews')?.checked;
                const showRichWorksets = document.getElementById('showRichWorksets')?.checked;
                
                if (showRichFamilies !== undefined) {
                    if (showRichFamilies) {
                        filtered = filtered.filter(item => (item.familyCount || 0) > 50);
                    }
                }
                
                if (showRichViews !== undefined) {
                    if (showRichViews) {
                        filtered = filtered.filter(item => (item.totalViews || 0) > 20);
                    }
                }
                
                if (showRichWorksets !== undefined) {
                    if (showRichWorksets) {
                        filtered = filtered.filter(item => (item.worksetCount || 0) > 5);
                    }
                }
                
                this.filteredData = filtered;
                this.updateStats();
                this.renderTable();
                this.updateComprehensiveData();
            }
            
            
            updateStats() {
                const stats = {
                    totalHubs: new Set(this.data.map(item => item.hubName)).size,
                    totalProjects: new Set(this.data.map(item => item.projectName)).size,
                    totalModels: new Set(this.data.map(item => item.modelName)).size,
                    totalFiles: this.data.length
                };
                
                const totalHubsEl = document.getElementById('totalHubs');
                const totalProjectsEl = document.getElementById('totalProjects');
                const totalModelsEl = document.getElementById('totalModels');
                const totalFilesEl = document.getElementById('totalFiles');
                
                if (totalHubsEl) totalHubsEl.textContent = stats.totalHubs;
                if (totalProjectsEl) totalProjectsEl.textContent = stats.totalProjects;
                if (totalModelsEl) totalModelsEl.textContent = stats.totalModels;
                if (totalFilesEl) totalFilesEl.textContent = stats.totalFiles;
            }
            
            renderTable() {
                const tbody = document.getElementById('dataTableBody');
                if (!tbody) {
                    console.warn('âš ï¸ Data table body element not found');
                    return;
                }
                
                tbody.innerHTML = '';
                
                this.filteredData.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.hubName}</td>
                        <td>${item.projectName}</td>
                        <td>${item.modelName}</td>
                        <td>${item.timestamp.toLocaleDateString()}</td>
                        <td>${item.totalElements.toLocaleString()}</td>
                        <td>${item.totalViews.toLocaleString()}</td>
                        <td>${item.warningCount}</td>
                        <td>${item.executionTime.toFixed(2)}s</td>
                        <td>${item.revitVersion || 'Unknown'}</td>
                    `;
                    tbody.appendChild(row);
                });
            }
            
            sortTable(column) {
                if (this.currentSort.column === column) {
                    this.currentSort.direction = this.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.currentSort.column = column;
                    this.currentSort.direction = 'asc';
                }
                
                this.filteredData.sort((a, b) => {
                    let aVal = a[column];
                    let bVal = b[column];
                    
                    if (typeof aVal === 'string') {
                        aVal = aVal.toLowerCase();
                        bVal = bVal.toLowerCase();
                    }
                    
                    if (this.currentSort.direction === 'asc') {
                        return aVal > bVal ? 1 : -1;
                    } else {
                        return aVal < bVal ? 1 : -1;
                    }
                });
                
                this.renderTable();
                this.updateSortIcons();
            }
            
            updateSortIcons() {
                document.querySelectorAll('.sort-icon').forEach(icon => {
                    icon.textContent = 'â†•';
                });
                
                if (this.currentSort.column) {
                    const header = document.querySelector(`[data-sort="${this.currentSort.column}"] .sort-icon`);
                    if (header) {
                        header.textContent = this.currentSort.direction === 'asc' ? 'â†‘' : 'â†“';
                    }
                }
            }
            
            createCharts() {
                this.createComparisonChart();
            }
            
            
            createComparisonChart() {
                const ctx = document.getElementById('comparisonChart').getContext('2d');
                
                const metric = document.getElementById('comparisonMetric').value;
                
                // Aggregate data by project
                const projectData = {};
                this.filteredData.forEach(item => {
                    const key = item.projectName;
                    if (!projectData[key]) {
                        projectData[key] = 0;
                    }
                    projectData[key] += item[metric];
                });
                
                const labels = Object.keys(projectData);
                const data = Object.values(projectData);
                
                this.charts.comparison = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [{
                            label: metric,
                            data,
                            backgroundColor: 'rgba(0, 255, 136, 0.6)',
                            borderColor: 'rgba(0, 255, 136, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            updateTimeSeriesChart() {
                if (this.charts.timeSeries) {
                    this.charts.timeSeries.destroy();
                }
                this.createTimeSeriesChart();
            }
            
            updateComparisonChart() {
                if (this.charts.comparison) {
                    this.charts.comparison.destroy();
                }
                this.createComparisonChart();
            }
            
            updateCharts() {
                this.updateTimeSeriesChart();
                this.updateComparisonChart();
            }
            
            // Comprehensive Data Display Functions
            updateComprehensiveData() {
                this.updateProjectTree();
                this.updateProjectOverview();
                this.updateWarningAnalysis();
                this.updateModelStructure();
                this.updateFamiliesAnalysis();
                this.updateGroupUsage();
                this.updateTemplatesFilters();
                this.updateCADFilesAnalysis();
                this.updateRoomsAnalysis();
                this.updateWorksetsAnalysis();
                this.updateRevitVersionAnalysis();
                this.updatePerformanceMetrics();
            }
            
            updateProjectTree() {
                const projectTreeEl = document.getElementById('projectTree');
                if (!projectTreeEl) return;
                
                // Group data by hub, then by project, then by model
                const treeData = {};
                
                this.filteredData.forEach(item => {
                    const hubName = item.hubName || 'Unknown Hub';
                    const projectName = item.projectName || 'Unknown Project';
                    const modelName = item.modelName || 'Unknown Model';
                    
                    if (!treeData[hubName]) {
                        treeData[hubName] = {};
                    }
                    if (!treeData[hubName][projectName]) {
                        treeData[hubName][projectName] = [];
                    }
                    treeData[hubName][projectName].push(modelName);
                });
                
                // Generate HTML for the tree structure
                let treeHTML = '';
                
                Object.entries(treeData).forEach(([hubName, projects]) => {
                    treeHTML += `
                        <div class="tree-node">
                            <div class="tree-item hub-item expandable" data-hub="${hubName}">
                                <button class="tree-toggle expanded"></button>
                                <span class="tree-icon"><img src="asset/icon/building.png" alt="Hub" class="icon icon-16 icon-invert"></span>
                                <span class="tree-label">${hubName}</span>
                            </div>
                            <div class="tree-children">
                    `;
                    
                    Object.entries(projects).forEach(([projectName, models]) => {
                        treeHTML += `
                            <div class="tree-node">
                                <div class="tree-item project-item expandable" data-project="${projectName}">
                                    <button class="tree-toggle expanded"></button>
                                    <span class="tree-icon"><img src="asset/icon/data.png" alt="Project" class="icon icon-16 icon-invert"></span>
                                    <span class="tree-label">${projectName}</span>
                                </div>
                                <div class="tree-children">
                        `;
                        
                        models.forEach(modelName => {
                            treeHTML += `
                                <div class="tree-node">
                                    <div class="tree-item model-item" data-model="${modelName}">
                                        <span class="tree-icon"><img src="asset/icon/tree-node.png" alt="Model" class="icon icon-16 icon-invert"></span>
                                        <span class="tree-label">${modelName}</span>
                                    </div>
                                </div>
                            `;
                        });
                        
                        treeHTML += `
                                </div>
                            </div>
                        `;
                    });
                    
                    treeHTML += `
                            </div>
                        </div>
                    `;
                });
                
                projectTreeEl.innerHTML = treeHTML;
                
                // Re-setup tree interactions after dynamic generation
                this.setupTreeInteractions();
            }
            
            updateWarningAnalysis() {
                const warningCategoriesEl = document.getElementById('warningCategories');
                const warningUsersEl = document.getElementById('warningUsers');
                
                if (!warningCategoriesEl || !warningUsersEl) return;
                
                // Aggregate warning categories across all data
                const warningCategories = {};
                const warningUsers = {};
                
                // Calculate warning statistics from available data
                const totalWarnings = this.filteredData.reduce((sum, item) => sum + (item.warningCount || 0), 0);
                const criticalWarnings = this.filteredData.reduce((sum, item) => sum + (item.criticalWarningCount || 0), 0);
                const avgWarnings = this.filteredData.length > 0 ? (totalWarnings / this.filteredData.length).toFixed(1) : 0;
                
                // Group warnings by model
                this.filteredData.forEach(item => {
                    const modelName = item.modelName;
                    const warnings = item.warningCount || 0;
                    if (!warningUsers[modelName]) {
                        warningUsers[modelName] = warnings;
                    }
                });
                
                // Display warning summary
                warningCategoriesEl.innerHTML = `
                    <div class="warning-category">
                        <span class="category-name">Total Warnings</span>
                        <span class="category-count">${totalWarnings}</span>
                    </div>
                    <div class="warning-category">
                        <span class="category-name">Critical Warnings</span>
                        <span class="category-count">${criticalWarnings}</span>
                    </div>
                    <div class="warning-category">
                        <span class="category-name">Average per Model</span>
                        <span class="category-count">${avgWarnings}</span>
                    </div>
                `;
                
                // Display warnings by model
                warningUsersEl.innerHTML = Object.entries(warningUsers)
                    .sort(([,a], [,b]) => b - a)
                    .map(([model, warnings]) => `
                        <div class="warning-user">
                            <div class="user-name">${model}</div>
                            <div class="user-warnings">
                                <div class="user-warning">${warnings} warnings</div>
                            </div>
                        </div>
                    `).join('');
            }
            
            updateModelStructure() {
                const viewBreakdownEl = document.getElementById('viewBreakdown');
                const elementBreakdownEl = document.getElementById('elementBreakdown');
                
                if (!viewBreakdownEl || !elementBreakdownEl) return;
                
                // Aggregate view types
                const viewTypes = {};
                const elementCounts = {
                    totalElements: 0,
                    totalViews: 0,
                    totalSheets: 0,
                    totalFamilies: 0,
                    dimensions: 0,
                    materials: 0,
                    textNotesInstances: 0
                };
                
                this.filteredData.forEach(item => {
                    // Aggregate available data
                    elementCounts.totalElements += item.totalElements || 0;
                    elementCounts.totalViews += item.totalViews || 0;
                    elementCounts.totalSheets += item.totalSheets || 0;
                    elementCounts.totalFamilies += item.totalFamilies || 0;
                    elementCounts.dimensions += item.dimensions || 0;
                    elementCounts.materials += item.materials || 0;
                    elementCounts.textNotesInstances += item.textNotesInstances || 0;
                });
                
                // Display model summary
                viewBreakdownEl.innerHTML = `
                    <div class="view-type">
                        <span class="view-type-name">Models Analyzed</span>
                        <span class="view-type-count">${this.filteredData.length}</span>
                    </div>
                    <div class="view-type">
                        <span class="view-type-name">Total Views</span>
                        <span class="view-type-count">${elementCounts.totalViews}</span>
                    </div>
                    <div class="view-type">
                        <span class="view-type-name">Total Sheets</span>
                        <span class="view-type-count">${elementCounts.totalSheets}</span>
                    </div>
                `;
                
                // Display element breakdown
                elementBreakdownEl.innerHTML = Object.entries(elementCounts)
                    .map(([element, count]) => `
                        <div class="element-count">
                            <span class="element-name">${element.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</span>
                            <span class="element-value">${count.toLocaleString()}</span>
                        </div>
                    `).join('');
            }
            
            updateGroupUsage() {
                const groupUsageEl = document.getElementById('groupUsage');
                if (!groupUsageEl) return;
                
                // Aggregate group usage data
                const groupData = {
                    totalTypes: 0,
                    overusedCount: 0,
                    overusedGroups: []
                };
                
                // Calculate basic metrics from available data
                const totalModels = this.filteredData.length;
                const totalElements = this.filteredData.reduce((sum, item) => sum + (item.totalElements || 0), 0);
                const totalFamilies = this.filteredData.reduce((sum, item) => sum + (item.totalFamilies || 0), 0);
                const avgElementsPerModel = totalModels > 0 ? (totalElements / totalModels).toFixed(0) : 0;
                
                groupUsageEl.innerHTML = `
                    <div class="group-stats">
                        <div class="group-stat">
                            <span class="stat-label">TOTAL MODELS</span>
                            <span class="stat-value">${totalModels}</span>
                        </div>
                        <div class="group-stat">
                            <span class="stat-label">TOTAL ELEMENTS</span>
                            <span class="stat-value">${totalElements.toLocaleString()}</span>
                        </div>
                        <div class="group-stat">
                            <span class="stat-label">TOTAL FAMILIES</span>
                            <span class="stat-value">${totalFamilies}</span>
                        </div>
                        <div class="group-stat">
                            <span class="stat-label">AVG ELEMENTS/MODEL</span>
                            <span class="stat-value">${avgElementsPerModel}</span>
                        </div>
                    </div>
                `;
            }
            
            updateTemplatesFilters() {
                const templatesFiltersEl = document.getElementById('templatesFilters');
                if (!templatesFiltersEl) return;
                
                // Aggregate templates and filters data
                const templatesData = {
                    unusedViewTemplates: 0,
                    filters: 0,
                    unusedFilters: 0,
                    viewTemplates: 0
                };
                
                // Calculate view and sheet metrics from available data
                const totalViews = this.filteredData.reduce((sum, item) => sum + (item.totalViews || 0), 0);
                const totalSheets = this.filteredData.reduce((sum, item) => sum + (item.totalSheets || 0), 0);
                const viewsNotOnSheets = this.filteredData.reduce((sum, item) => sum + (item.viewsNotOnSheets || 0), 0);
                const copiedViews = this.filteredData.reduce((sum, item) => sum + (item.copiedViews || 0), 0);
                
                templatesFiltersEl.innerHTML = `
                    <div class="templates-stats">
                        <div class="template-stat">
                            <span class="stat-label">Total Views</span>
                            <span class="stat-value">${totalViews}</span>
                        </div>
                        <div class="template-stat">
                            <span class="stat-label">Total Sheets</span>
                            <span class="stat-value">${totalSheets}</span>
                        </div>
                        <div class="template-stat">
                            <span class="stat-label">Views Not on Sheets</span>
                            <span class="stat-value">${viewsNotOnSheets}</span>
                        </div>
                        <div class="template-stat">
                            <span class="stat-label">Copied Views</span>
                            <span class="stat-value">${copiedViews}</span>
                        </div>
                    </div>
                `;
            }
            
            updateProjectOverview() {
                const projectOverviewEl = document.getElementById('projectOverview');
                if (!projectOverviewEl) return;
                
                // Get unique project information
                const uniqueProjects = [...new Set(this.filteredData.map(item => item.projectName))];
                const uniqueHubs = [...new Set(this.filteredData.map(item => item.hubName))];
                const totalModels = this.filteredData.length;
                const totalElements = this.filteredData.reduce((sum, item) => sum + (item.totalElements || 0), 0);
                const totalViews = this.filteredData.reduce((sum, item) => sum + (item.totalViews || 0), 0);
                const totalWarnings = this.filteredData.reduce((sum, item) => sum + (item.warningCount || 0), 0);
                
                projectOverviewEl.innerHTML = `
                    <div class="project-stats">
                        <div class="project-stat">
                            <span class="stat-label">Hubs</span>
                            <span class="stat-value">${uniqueHubs.length}</span>
                        </div>
                        <div class="project-stat">
                            <span class="stat-label">Projects</span>
                            <span class="stat-value">${uniqueProjects.length}</span>
                        </div>
                        <div class="project-stat">
                            <span class="stat-label">Models</span>
                            <span class="stat-value">${totalModels}</span>
                        </div>
                        <div class="project-stat">
                            <span class="stat-label">Total Elements</span>
                            <span class="stat-value">${totalElements.toLocaleString()}</span>
                        </div>
                        <div class="project-stat">
                            <span class="stat-label">Total Views</span>
                            <span class="stat-value">${totalViews}</span>
                        </div>
                        <div class="project-stat">
                            <span class="stat-label">Total Warnings</span>
                            <span class="stat-value">${totalWarnings}</span>
                        </div>
                    </div>
                `;
            }
            
            updateFamiliesAnalysis() {
                const familiesAnalysisEl = document.getElementById('familiesAnalysis');
                if (!familiesAnalysisEl) return;
                
                // Aggregate families data
                const familiesData = {
                    totalFamilies: 0,
                    nonParametricFamilies: 0,
                    inPlaceFamilies: 0,
                    detailComponents: 0,
                    genericModelsTypes: 0,
                    familyCreators: {}
                };
                
                this.filteredData.forEach(item => {
                    if (item.families) {
                        familiesData.totalFamilies += item.families.total_families || 0;
                        familiesData.nonParametricFamilies += item.families.non_parametric_families || 0;
                        familiesData.inPlaceFamilies += item.families.in_place_families || 0;
                        familiesData.detailComponents += item.families.detail_components || 0;
                        familiesData.genericModelsTypes += item.families.generic_models_types || 0;
                        
                        // Aggregate family creators
                        if (item.families.non_parametric_families_creators) {
                            Object.entries(item.families.non_parametric_families_creators).forEach(([creator, count]) => {
                                familiesData.familyCreators[creator] = (familiesData.familyCreators[creator] || 0) + count;
                            });
                        }
                    }
                });
                
                familiesAnalysisEl.innerHTML = `
                    <div class="families-stats">
                        <div class="family-stat">
                            <span class="stat-label">Total Families</span>
                            <span class="stat-value">${familiesData.totalFamilies}</span>
                        </div>
                        <div class="family-stat">
                            <span class="stat-label">Non-Parametric</span>
                            <span class="stat-value">${familiesData.nonParametricFamilies}</span>
                        </div>
                        <div class="family-stat">
                            <span class="stat-label">In-Place Families</span>
                            <span class="stat-value">${familiesData.inPlaceFamilies}</span>
                        </div>
                        <div class="family-stat">
                            <span class="stat-label">Detail Components</span>
                            <span class="stat-value">${familiesData.detailComponents}</span>
                        </div>
                        <div class="family-stat">
                            <span class="stat-label">Generic Models</span>
                            <span class="stat-value">${familiesData.genericModelsTypes}</span>
                        </div>
                    </div>
                    ${Object.keys(familiesData.familyCreators).length > 0 ? `
                        <div class="family-creators">
                            <h5>Family Creators</h5>
                            ${Object.entries(familiesData.familyCreators)
                                .sort(([,a], [,b]) => b - a)
                                .map(([creator, count]) => `
                                    <div class="creator-stat">
                                        <span class="creator-name">${creator}</span>
                                        <span class="creator-count">${count} families</span>
                                    </div>
                                `).join('')}
                        </div>
                    ` : ''}
                `;
            }
            
            updateCADFilesAnalysis() {
                const cadFilesAnalysisEl = document.getElementById('cadFilesAnalysis');
                if (!cadFilesAnalysisEl) return;
                
                // Aggregate CAD files data
                const cadData = {
                    importedDwgs: 0,
                    linkedDwgs: 0,
                    dwgFiles: 0,
                    cadLayersImportsInFamilies: 0
                };
                
                this.filteredData.forEach(item => {
                    if (item.cad_files) {
                        cadData.importedDwgs += item.cad_files.imported_dwgs || 0;
                        cadData.linkedDwgs += item.cad_files.linked_dwgs || 0;
                        cadData.dwgFiles += item.cad_files.dwg_files || 0;
                        cadData.cadLayersImportsInFamilies += item.cad_files.cad_layers_imports_in_families || 0;
                    }
                });
                
                cadFilesAnalysisEl.innerHTML = `
                    <div class="cad-stats">
                        <div class="cad-stat">
                            <span class="stat-label">Imported DWGs</span>
                            <span class="stat-value">${cadData.importedDwgs}</span>
                        </div>
                        <div class="cad-stat">
                            <span class="stat-label">Linked DWGs</span>
                            <span class="stat-value">${cadData.linkedDwgs}</span>
                        </div>
                        <div class="cad-stat">
                            <span class="stat-label">DWG Files</span>
                            <span class="stat-value">${cadData.dwgFiles}</span>
                        </div>
                        <div class="cad-stat">
                            <span class="stat-label">CAD Layers in Families</span>
                            <span class="stat-value">${cadData.cadLayersImportsInFamilies}</span>
                        </div>
                    </div>
                `;
            }
            
            updateRoomsAnalysis() {
                const roomsAnalysisEl = document.getElementById('roomsAnalysis');
                if (!roomsAnalysisEl) return;
                
                // Aggregate rooms data
                const roomsData = {
                    totalRooms: 0,
                    unplacedRooms: 0,
                    unboundedRooms: 0
                };
                
                this.filteredData.forEach(item => {
                    if (item.rooms) {
                        roomsData.totalRooms += item.rooms.total_rooms || 0;
                        roomsData.unplacedRooms += item.rooms.unplaced_rooms || 0;
                        roomsData.unboundedRooms += item.rooms.unbounded_rooms || 0;
                    }
                });
                
                roomsAnalysisEl.innerHTML = `
                    <div class="rooms-stats">
                        <div class="room-stat">
                            <span class="stat-label">Total Rooms</span>
                            <span class="stat-value">${roomsData.totalRooms}</span>
                        </div>
                        <div class="room-stat">
                            <span class="stat-label">Unplaced Rooms</span>
                            <span class="stat-value">${roomsData.unplacedRooms}</span>
                        </div>
                        <div class="room-stat">
                            <span class="stat-label">Unbounded Rooms</span>
                            <span class="stat-value">${roomsData.unboundedRooms}</span>
                        </div>
                    </div>
                `;
            }
            
            updateWorksetsAnalysis() {
                const worksetsAnalysisEl = document.getElementById('worksetsAnalysis');
                if (!worksetsAnalysisEl) return;
                
                // Aggregate worksets data
                const worksetsData = {
                    totalWorksets: 0,
                    userWorksets: 0,
                    standardWorksets: 0,
                    worksetOwners: {}
                };
                
                this.filteredData.forEach(item => {
                    if (item.project_info && item.project_info.worksets) {
                        const worksets = item.project_info.worksets.workset_details || [];
                        worksetsData.totalWorksets += worksets.length;
                        
                        worksets.forEach(workset => {
                            if (workset.kind === 'UserWorkset') {
                                worksetsData.userWorksets++;
                            } else if (workset.kind === 'StandardWorkset') {
                                worksetsData.standardWorksets++;
                            }
                            
                            if (workset.owner) {
                                worksetsData.worksetOwners[workset.owner] = (worksetsData.worksetOwners[workset.owner] || 0) + 1;
                            }
                        });
                    }
                });
                
                worksetsAnalysisEl.innerHTML = `
                    <div class="worksets-stats">
                        <div class="workset-stat">
                            <span class="stat-label">Total Worksets</span>
                            <span class="stat-value">${worksetsData.totalWorksets}</span>
                        </div>
                        <div class="workset-stat">
                            <span class="stat-label">User Worksets</span>
                            <span class="stat-value">${worksetsData.userWorksets}</span>
                        </div>
                        <div class="workset-stat">
                            <span class="stat-label">Standard Worksets</span>
                            <span class="stat-value">${worksetsData.standardWorksets}</span>
                        </div>
                    </div>
                    ${Object.keys(worksetsData.worksetOwners).length > 0 ? `
                        <div class="workset-owners">
                            <h5>Workset Owners</h5>
                            ${Object.entries(worksetsData.worksetOwners)
                                .sort(([,a], [,b]) => b - a)
                                .map(([owner, count]) => `
                                    <div class="owner-stat">
                                        <span class="owner-name">${owner}</span>
                                        <span class="owner-count">${count} worksets</span>
                                    </div>
                                `).join('')}
                        </div>
                    ` : ''}
                `;
            }
            
            updateRevitVersionAnalysis() {
                const revitVersionAnalysisEl = document.getElementById('revitVersionAnalysis');
                if (!revitVersionAnalysisEl) return;

                // Aggregate Revit application version data (Autodesk Revit year versions)
                const versionData = {};
                const versionStats = {
                    totalModels: 0,
                    uniqueVersions: 0,
                    versionBreakdown: {},
                    latestVersion: null,
                    oldestVersion: null
                };
                
                this.filteredData.forEach(item => {
                    const version = item.revitVersion || 'Unknown';
                    versionStats.totalModels++;
                    
                    if (!versionData[version]) {
                        versionData[version] = {
                            count: 0,
                            models: [],
                            totalElements: 0,
                            totalViews: 0,
                            totalWarnings: 0,
                            avgExecutionTime: 0,
                            executionTimes: []
                        };
                    }
                    
                    versionData[version].count++;
                    versionData[version].models.push(item.modelName);
                    versionData[version].totalElements += item.totalElements || 0;
                    versionData[version].totalViews += item.totalViews || 0;
                    versionData[version].totalWarnings += item.warningCount || 0;
                    versionData[version].executionTimes.push(item.executionTime || 0);
                });
                
                // Calculate averages and find latest/oldest versions
                Object.keys(versionData).forEach(version => {
                    const data = versionData[version];
                    data.avgExecutionTime = data.executionTimes.reduce((sum, time) => sum + time, 0) / data.executionTimes.length;
                    
                    // Convert version to number for comparison (e.g., "2024" -> 2024)
                    const versionNum = parseInt(version) || 0;
                    if (versionNum > 0) {
                        if (!versionStats.latestVersion || versionNum > parseInt(versionStats.latestVersion)) {
                            versionStats.latestVersion = version;
                        }
                        if (!versionStats.oldestVersion || versionNum < parseInt(versionStats.oldestVersion)) {
                            versionStats.oldestVersion = version;
                        }
                    }
                });
                
                versionStats.uniqueVersions = Object.keys(versionData).length;
                versionStats.versionBreakdown = versionData;
                
                // Display Revit application version analysis
                revitVersionAnalysisEl.innerHTML = `
                    <div class="revit-version-stats">
                        <div class="version-stat">
                            <span class="stat-label">Total Models</span>
                            <span class="stat-value">${versionStats.totalModels}</span>
                        </div>
                        <div class="version-stat">
                            <span class="stat-label">Unique Application Versions</span>
                            <span class="stat-value">${versionStats.uniqueVersions}</span>
                        </div>
                        <div class="version-stat">
                            <span class="stat-label">Latest Application Version</span>
                            <span class="stat-value">${versionStats.latestVersion || 'Unknown'}</span>
                        </div>
                        <div class="version-stat">
                            <span class="stat-label">Oldest Application Version</span>
                            <span class="stat-value">${versionStats.oldestVersion || 'Unknown'}</span>
                        </div>
                    </div>
                    <div class="version-breakdown">
                        <h5>Application Version Breakdown</h5>
                        ${Object.entries(versionStats.versionBreakdown)
                            .sort(([a], [b]) => parseInt(b) - parseInt(a)) // Sort by version number descending
                            .map(([version, data]) => `
                                <div class="version-detail">
                                    <div class="version-header">
                                        <span class="version-name">Revit ${version} Application</span>
                                        <span class="version-count">${data.count} models</span>
                                    </div>
                                    <div class="version-metrics">
                                        <div class="version-metric">
                                            <span class="metric-label">Elements</span>
                                            <span class="metric-value">${data.totalElements.toLocaleString()}</span>
                                        </div>
                                        <div class="version-metric">
                                            <span class="metric-label">Views</span>
                                            <span class="metric-value">${data.totalViews}</span>
                                        </div>
                                        <div class="version-metric">
                                            <span class="metric-label">Warnings</span>
                                            <span class="metric-value">${data.totalWarnings}</span>
                                        </div>
                                        <div class="version-metric">
                                            <span class="metric-label">Avg Exec Time</span>
                                            <span class="metric-value">${data.avgExecutionTime.toFixed(2)}s</span>
                                        </div>
                                    </div>
                                    <div class="version-models">
                                        <strong>Models:</strong> ${data.models.join(', ')}
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                `;
            }
            
            updatePerformanceMetrics() {
                const performanceMetricsEl = document.getElementById('performanceMetrics');
                if (!performanceMetricsEl) return;
                
                // Calculate performance metrics
                const totalExecutionTime = this.filteredData.reduce((sum, item) => sum + (item.executionTime || 0), 0);
                const avgExecutionTime = totalExecutionTime / this.filteredData.length;
                const totalElements = this.filteredData.reduce((sum, item) => sum + (item.totalElements || 0), 0);
                const totalWarnings = this.filteredData.reduce((sum, item) => sum + (item.warningCount || 0), 0);
                const totalViews = this.filteredData.reduce((sum, item) => sum + (item.totalViews || 0), 0);
                
                performanceMetricsEl.innerHTML = `
                    <div class="performance-stats">
                        <div class="performance-stat">
                            <span class="stat-label">Total Execution Time</span>
                            <span class="stat-value">${totalExecutionTime.toFixed(2)}s</span>
                        </div>
                        <div class="performance-stat">
                            <span class="stat-label">Average Execution Time</span>
                            <span class="stat-value">${avgExecutionTime.toFixed(2)}s</span>
                        </div>
                        <div class="performance-stat">
                            <span class="stat-label">Elements per Second</span>
                            <span class="stat-value">${(totalElements / totalExecutionTime).toFixed(0)}</span>
                        </div>
                        <div class="performance-stat">
                            <span class="stat-label">Warning Rate</span>
                            <span class="stat-value">${((totalWarnings / totalElements) * 100).toFixed(2)}%</span>
                        </div>
                        <div class="performance-stat">
                            <span class="stat-label">Views per Model</span>
                            <span class="stat-value">${(totalViews / this.filteredData.length).toFixed(1)}</span>
                        </div>
                    </div>
                `;
            }
            
            exportToCSV() {
                const headers = ['Hub', 'Project', 'Model', 'Date', 'Elements', 'Views', 'Warnings', 'Execution Time', 'Revit Version', 'Format'];
                const csvContent = [
                    headers.join(','),
                    ...this.filteredData.map(item => [
                        item.hubName,
                        item.projectName,
                        item.modelName,
                        item.timestamp.toLocaleDateString(),
                        item.totalElements,
                        item.totalViews,
                        item.warningCount,
                        item.executionTime,
                        item.revitVersion || 'Unknown',
                        item.format || 'Unknown'
                    ].join(','))
                ].join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'healthmetric_data.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
            
            showLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = 'flex';
                overlay.classList.remove('hidden');
            }
            
            hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.style.display = 'none';
                overlay.classList.add('hidden');
            }
            
            showError(message) {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = overlay.querySelector('.loading-text');
                loadingText.textContent = message;
                loadingText.style.color = '#ff6b6b';
            }
        }
        
        // Global navigation function
        function navigateToHero() {
            console.log('ðŸ”„ Global navigation to hero page');
            try {
                window.location.href = 'index.html';
            } catch (error) {
                console.error('âŒ Navigation failed:', error);
                window.history.back();
            }
        }

        // Initialize dashboard when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            try {
                new DashboardApp();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                // Hide loading screen as fallback
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = 'none';
                }
            }
        });
        
        // Fallback: Hide loading screen after 5 seconds regardless
        setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay && overlay.style.display !== 'none') {
                overlay.style.display = 'none';
                console.log('Loading screen hidden by fallback timeout');
            }
        }, 5000);
    </script>
</body>
</html>
